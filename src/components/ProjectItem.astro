---
export interface ImageSlide {
    kind: "image";
    src: string;
    alt: string;
}

export interface VideoSource {
    src: string;
    type?: string;
}

export interface VideoSlide {
    kind: "video";
    sources: VideoSource[];
    poster?: string;
}

export type Slide = ImageSlide | VideoSlide;

export interface Props {
    name: string;
    description: string;
    slides?: Slide[];
    stack: string[];
    liveUrl?: string;
    repoUrl?: string;
    nameKey?: string;
    descriptionKey?: string;
}

const {
    name,
    description,
    slides = [],
    stack = [],
    liveUrl,
    repoUrl,
    nameKey,
    descriptionKey,
} = Astro.props;
const hasSlides = slides.length > 0;
---

<article class="project-card" role="listitem">
    {
        hasSlides ? (
            <div class="project-card__carousel" role="region" aria-label={`Galería de ${name}`}>
                <div class="project-card__slides">
                    {slides.map((slide, index) => (
                        <figure
                            class={`project-card__slide ${index === 0 ? "project-card__slide--active" : ""}`}
                            key={`${slide.kind}-${index}`}
                        >
                            {slide.kind === "image" ? (
                                <img
                                    loading="lazy"
                                    src={slide.src}
                                    alt={slide.alt}
                                />
                            ) : (
                                <video
                                    preload="none"
                                    controls
                                    playsinline
                                    muted
                                    poster={slide.poster}
                                >
                                    {slide.sources.map(
                                        (source, sourceIndex) => (
                                            <source
                                                src={source.src}
                                                type={source.type}
                                                key={`${source.src}-${sourceIndex}`}
                                            />
                                        ),
                                    )}
                                    <span data-i18n-key="project.videoFallback">
                                        Tu navegador no soporta video.
                                    </span>
                                </video>
                            )}
                        </figure>
                    ))}
                </div>
                <div class="project-card__controls" aria-label="Controles del carrusel">
                    <button
                        class="project-card__arrow project-card__arrow--left"
                        type="button"
                        aria-label="Anterior"
                        data-i18n-attr-aria-label="project.carousel.prev"
                    >
                        <span aria-hidden="true">&lsaquo;</span>
                    </button>
                    <button
                        class="project-card__arrow project-card__arrow--right"
                        type="button"
                        aria-label="Siguiente"
                        data-i18n-attr-aria-label="project.carousel.next"
                    >
                        <span aria-hidden="true">&rsaquo;</span>
                    </button>
                    <div class="project-card__dots" role="tablist" aria-label="Indicadores de diapositivas">
                        {slides.map((_, index) => (
                            <button
                                class={`project-card__dot ${index === 0 ? "project-card__dot--active" : ""}`}
                                key={`dot-${index}`}
                                data-index={index}
                                role="tab"
                                aria-selected={index === 0 ? "true" : "false"}
                                aria-label={`Diapositiva ${index + 1}`}
                            />
                        ))}
                    </div>
                </div>
            </div>
        ) : (
            <div
                class="project-card__no-preview"
                data-i18n-key="project.noPreview"
                role="img"
                aria-label="Sin vista previa disponible"
            >
                Sin vista previa
            </div>
        )
    }
    <div class="project-card__content">
        <h3 class="project-card__title" data-i18n-key={nameKey}>{name}</h3>
        <p class="project-card__description" data-i18n-key={descriptionKey}>
            {description}
        </p>
        <footer class="project-card__footer">
            {
                stack.length > 0 && (
                    <div class="project-card__tags" role="list" aria-label="Tecnologías utilizadas">
                        {stack.map((tech) => (
                            <span class="project-card__tag" role="listitem" key={tech}>
                                {tech}
                            </span>
                        ))}
                    </div>
                )
            }
            {
                (liveUrl || repoUrl) && (
                    <nav class="project-card__links" aria-label="Enlaces del proyecto">
                        {liveUrl && (
                            <a
                                class="project-card__btn project-card__btn--primary"
                                href={liveUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                data-i18n-key="project.button.live"
                            >
                                Ver demo
                            </a>
                        )}
                        {repoUrl && (
                            <a
                                class="project-card__btn project-card__btn--ghost"
                                href={repoUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                data-i18n-key="project.button.repo"
                            >
                                Repositorio
                            </a>
                        )}
                    </nav>
                )
            }
        </footer>
    </div>
</article>

<script>
    (function () {
        const root =
            document.currentScript &&
            document.currentScript.closest("article.project-card");
        if (!root) return;

        const slides = Array.from(
            root.querySelectorAll(".project-card__slide"),
        );
        if (slides.length === 0) {
            return;
        }
        const dots = Array.from(root.querySelectorAll(".project-card__dot"));
        const btnLeft = root.querySelector(".project-card__arrow--left");
        const btnRight = root.querySelector(".project-card__arrow--right");
        let index = 0;

        function setActive(i) {
            index = (i + slides.length) % slides.length;
            slides.forEach((el, idx) => {
                el.classList.toggle(
                    "project-card__slide--active",
                    idx === index,
                );
            });
            dots.forEach((d, idx) => {
                d.classList.toggle("project-card__dot--active", idx === index);
                d.setAttribute("aria-selected", idx === index ? "true" : "false");
            });
        }

        btnLeft &&
            btnLeft.addEventListener("click", () => setActive(index - 1));
        btnRight &&
            btnRight.addEventListener("click", () => setActive(index + 1));
        dots.forEach((d, idx) =>
            d.addEventListener("click", () => setActive(idx)),
        );

        if (slides.length <= 1) {
            const ctrl = root.querySelector(".project-card__controls");
            if (ctrl) ctrl.style.display = "none";
        }

        setActive(0);
    })();
</script>

<style>
    /* Card principal */
    .project-card {
        display: flex;
        flex-direction: column;
        gap: clamp(6px, 1vh, var(--space-sm));
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--br-big);
        padding: clamp(3px, 0.5vh, var(--space-xs));
        width: 100%;
        max-width: 100%;
        height: 100%;
        min-height: 0;
        min-width: 0;
        box-sizing: border-box;
        overflow: hidden;
    }

    /* Sin preview */
    .project-card__no-preview {
        display: grid;
        place-items: center;
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: var(--br-mid);
        background: rgba(255, 255, 255, 0.05);
        font-size: 0.9rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.75;
        padding: var(--space-md);
    }

    /* Carousel */
    .project-card__carousel {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: var(--br-mid);
        overflow: hidden;
        background: #0d131d;
        padding: 0;
    }

    .project-card__slides {
        position: absolute;
        inset: 0;
        overflow: hidden;
        padding: 0;
    }

    .project-card__slide {
        position: absolute;
        inset: 0;
        padding: 0;
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 200ms ease-in-out,
            visibility 200ms ease-in-out;
    }

    .project-card__slide--active {
        opacity: 1;
        visibility: visible;
    }

    .project-card__slide img,
    .project-card__slide video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* Controles del carousel */
    .project-card__controls {
        position: absolute;
        inset: 0;
        pointer-events: none;
        padding: 0;
    }

    .project-card__arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: auto;
        width: 34px;
        height: 34px;
        display: grid;
        place-items: center;
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(4px);
        color: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0;
    }

    .project-card__arrow:hover {
        background: rgba(0, 0, 0, 0.5);
        transform: translateY(-50%) scale(1.1);
    }

    .project-card__arrow--left {
        left: var(--space-sm);
    }

    .project-card__arrow--right {
        right: var(--space-sm);
    }

    .project-card__dots {
        position: absolute;
        left: 0;
        right: 0;
        bottom: var(--space-sm);
        display: flex;
        gap: var(--space-sm);
        justify-content: center;
        pointer-events: auto;
        padding: 0;
    }

    .project-card__dot {
        width: var(--space-sm);
        height: var(--space-sm);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.35);
        cursor: pointer;
        transition: background 0.2s ease;
        border: none;
        padding: 0;
    }

    .project-card__dot:hover {
        background: rgba(255, 255, 255, 0.6);
    }

    .project-card__dot--active {
        background: #fff;
    }

    /* Contenido */
    .project-card__content {
        display: flex;
        flex-direction: column;
        gap: clamp(8px, 1.5vh, 12px);
        flex: 1;
        min-width: 0;
        max-width: 100%;
        overflow: hidden;
    }

    .project-card__title {
        font-size: var(--project-title-max);
        padding: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .project-card__description {
        font-size: var(--project-desc-max);
        line-height: 1.35;
        padding: 0;
    }

    /* Footer */
    .project-card__footer {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
        padding-top: var(--space-xs);
        min-width: 0;
        max-width: 100%;
        overflow: hidden;
    }

    .project-card__tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-xs);
        min-width: 0;
        max-width: 100%;
        overflow: hidden;
        padding: 0;
    }

    .project-card__tag {
        display: inline-flex;
        align-items: center;
        font-size: clamp(0.7rem, 0.78rem, 0.85rem);
        font-weight: 500;
        line-height: 1;
        padding: clamp(0.3rem, 0.35rem, 0.4rem) clamp(0.5rem, 0.6rem, 0.7rem);
        border-radius: 9px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: #fafafa;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(4px);
        transition: all 160ms ease;
        box-shadow:
            0 1px 0 rgba(255, 255, 255, 0.08) inset,
            0 4px 16px rgba(0, 0, 0, 0.25);
        flex-shrink: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        box-sizing: border-box;
    }

    .project-card__links {
        display: flex;
        gap: var(--space-sm);
        flex-wrap: wrap;
        min-width: 0;
        max-width: 100%;
        padding: 0;
    }

    .project-card__btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: clamp(0.8rem, 0.9rem, 1rem);
        font-weight: 600;
        line-height: 1;
        padding: clamp(0.45rem, 0.55rem, 0.65rem) clamp(0.7rem, 0.85rem, 1rem);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: #fafafa;
        background: rgba(255, 255, 255, 0.08);
        text-decoration: none;
        backdrop-filter: blur(4px);
        transition: all 160ms ease;
        box-shadow: 0 2px 18px rgba(0, 0, 0, 0.28);
        cursor: pointer;
        flex-shrink: 1;
        min-width: 0;
        max-width: 100%;
        box-sizing: border-box;
    }

    .project-card__btn:hover {
        transform: scale(1.04);
    }

    .project-card__btn--ghost {
        background: transparent;
        border-color: rgba(255, 255, 255, 0.22);
        color: #f0f0f0;
    }

    .project-card__btn--ghost:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    /* ============================ */
    /* Responsive Breakpoints       */
    /* ============================ */

    /* Desktop Grande: >= 1200px */
    @media (min-width: 1200px) {
        .project-card__title {
            font-size: 1rem;
        }

        .project-card__description {
            font-size: 0.8rem;
        }
    }

    /* Tablet Grande: 900px - 1199px */
    @media (min-width: 900px) and (max-width: 1199px) {
        .project-card__title {
            font-size: 0.9rem;
        }

        .project-card__description {
            font-size: 0.75rem;
        }
    }

    /* Tablet: 640px - 899px */
    @media (min-width: 640px) and (max-width: 899px) {
        .project-card__title {
            font-size: 0.85rem;
        }

        .project-card__description {
            font-size: 0.72rem;
        }
    }

    /* Mobile: < 640px */
    @media (max-width: 639px) {
        .project-card {
            display: grid;
            grid-template-columns: minmax(0, 48%) 1fr;
            grid-template-rows: 1fr;
            align-items: stretch;
            column-gap: 8px;
        }

        .project-card__carousel {
            grid-column: 1;
            grid-row: 1;
            align-self: stretch;
            aspect-ratio: unset;
            height: 100%;
        }

        .project-card__content {
            grid-column: 2;
            grid-row: 1;
            gap: 4px;
        }

        .project-card__title {
            font-size: 0.75rem;
        }

        .project-card__description {
            font-size: 0.65rem;
        }

        .project-card__tags {
            display: none !important;
        }
    }
</style>
