---
import "@/styles/global.css";
import Section from "@/layout/Section.astro";
import FormContainer from "../components/FormContainer.astro";
import NavBar from "../components/NavBar.astro";
---

<!doctype html>
<html lang="es" class="dark">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <link
            rel="icon"
            href="/favicon-dark.svg"
            media="(prefers-color-scheme: light)"
        />
        <link
            rel="icon"
            href="/favicon-light.svg"
            media="(prefers-color-scheme: dark)"
        />
        <title>Wipe con navbar</title>
    </head>

    <body class="bg-[#111111] m-0 overflow-hidden text-white">
        <FormContainer />
        <NavBar />
        <main id="app-main" class="h-[100dvh] w-screen p-4 box-border relative">
            <Section sectionName="Home" bgColor="bg-red-500" itsFirst={true}
                >SECTION 1</Section
            >
            <Section sectionName="About" bgColor="bg-blue-500"
                >SECTION 2</Section
            >
            <Section sectionName="Contact" bgColor="bg-green-500"
                >SECTION 3</Section
            >
        </main>

        <script>
            // @ts-nocheck
            const sections = Array.from(
                document.querySelectorAll('[id^="section-"]'),
            );
            let active =
                sections.find((s) => s.classList.contains("active")) || null;
            let lastActive = active;

            let token = 0;

            const byId = (id) => document.getElementById(id);
            const toId = (name) => "section-" + String(name).toLowerCase();

            function play(sectionEl) {
                if (!sectionEl || sectionEl === active) return;

                if (sectionEl.classList.contains("play-wipe")) return; // ya está en animación

                const my = ++token;

                // z-index: sólo el target arriba
                sections.forEach((s) => {
                    if (s.classList.contains("last")) {
                        s.classList.remove("last");
                    }
                    if (s.classList.contains("active")) {
                        s.classList.remove("active");
                        s.classList.add("last"); // marcar la que acaba de dejar de ser activa
                    }
                }); // quitar a todas
                sectionEl.classList.add("active");

                // no quitamos 'wiped' a otras; se quedan abiertas como pediste
                sectionEl.classList.remove("wiped");
                void sectionEl.offsetWidth; // reflow para resetear anim
                sectionEl.classList.add("play-wipe");
                sectionEl.classList.remove("last");

                const onEnd = (e) => {
                    if (e.animationName !== "wipeAnimation" || my !== token)
                        return;
                    sectionEl.removeEventListener("animationend", onEnd);
                    sectionEl.classList.remove("play-wipe");
                    sectionEl.classList.add("wiped"); // fijar estado al terminar

                    active = sectionEl;
                };
                sectionEl.addEventListener("animationend", onEnd, {
                    once: true,
                });

                sectionEl.addEventListener(
                    "animationcancel",
                    () => {
                        if (my !== token) return;
                        sectionEl.classList.remove("play-wipe");
                    },
                    { once: true },
                );
            }

            // API global para la NavBar
            window.setActiveSection = (name) => play(byId(toId(name)));
        </script>
    </body>
</html>
