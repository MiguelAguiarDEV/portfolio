---
import SectionControls from "../components/SectionControls.astro";

interface Props {
    bgColor?: string;
    showMenu?: boolean;
    showXDisplacement?: boolean;
    showWipeAngle?: boolean;
    showStaticXOffset?: boolean;
    defaultX?: number;
    defaultWipe?: number;
    defaultStatic?: number;
    sectionName?: string; // nombre legible para generar un id estable
    zIndex?: number; // índice z opcional para controlar la superposición
    itsFirst?: boolean; // si es la primera sección, para ajustes específicos
}

const {
    bgColor = "bg-gray-500",
    showMenu = false,
    showXDisplacement = true,
    showWipeAngle = true,
    showStaticXOffset = true,
    defaultX = 0,
    defaultWipe = 40,
    defaultStatic = -41,
    sectionName,
    zIndex = 10,
    itsFirst = false,
} = Astro.props;
const uniqueId = `section-${Math.random().toString(36).slice(2, 9)}`;
// Genera un id estable a partir del nombre si se provee (slug sencillo)
const stableId = sectionName
    ? `section-${sectionName
          .toString()
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9\s-_]/g, "")
          .replace(/\s+/g, "-")}`
    : uniqueId;
---

{
    showMenu && (
        <SectionControls
            sectionId={stableId}
            bgColor={bgColor}
            title="Controls"
            showXDisplacement={showXDisplacement}
            showWipeAngle={showWipeAngle}
            showStaticXOffset={showStaticXOffset}
            defaultX={defaultX}
            defaultWipe={defaultWipe}
            defaultStatic={defaultStatic}
        />
    )
}

<div
    id={stableId}
    class:list={[
        "section h-full w-full absolute inset-0",
        bgColor,
        `z-${zIndex} ${itsFirst ? "wiped" : ""}`,
    ]}
    style={`--x-displacement: ${defaultX}%; --wipe-angle: ${defaultWipe}%; --static-x-offset: ${defaultStatic}%;`}
>
    <section class="grid place-items-center h-full text-5xl font-extrabold">
        <slot />
    </section>
</div>

<style>
    /* Estado inicial: mostrar la sección completa antes de cualquier animación */

    [id^="section-"] {
        --x-displacement: 0%;
        --static-x-offset: -41%;
        --wipe-angle: 40%;

        --x1-position: var(--static-x-offset);
        --y1-position: 0%;

        --x2-position: var(--static-x-offset);
        --y2-position: 100%;

        --wipe-angle-modified: calc(var(--wipe-angle) - var(--static-x-offset));

        --x3-position: calc(
            var(--wipe-angle) + var(--x2-position) + var(--x-displacement)
        );
        --y3-position: var(--y2-position);

        --x4-position: calc(var(--x1-position) + var(--x-displacement));
        --y4-position: var(--y1-position);
    }

    [id^="section-"] {
        clip-path: polygon(
            var(--x1-position) var(--y1-position),
            var(--x2-position) var(--y2-position),
            var(--x3-position) var(--y3-position),
            var(--x4-position) var(--y4-position)
        );
    }
    /* La animación solo se activa añadiendo la clase .play-wipe */
    .play-wipe {
        animation: wipeAnimation 4s linear forwards;
    }

    @keyframes wipeAnimation {
        0% {
        }

        100% {
            clip-path: polygon(
                var(--x1-position) var(--y1-position),
                var(--x2-position) var(--y2-position),
                calc(var(--wipe-angle) + var(--x2-position) + 101%)
                    var(--y3-position),
                calc(var(--x1-position) + 141%) var(--y4-position)
            );
        }
    }

    .wiped {
        clip-path: polygon(0 0, 0 100%, 100% 100%, 100% 0);
    }
</style>
